<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="X-UA-Compatible" content="IE=8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="renderer" content="webkit">
    <title>用户画像</title>
    <script type="text/javascript" src="../startbootstrap/js/jquery.1.10.2.min.js"></script>
    <script type="text/javascript" src="../startbootstrap/js/layer.js"></script>
    <script type="text/javascript" src="../scripts/bidLib.js"></script>
    <script type="text/javascript" src="../scripts/ajaxfileupload.js"></script>
    <script type="text/javascript" src="select_view/select_option.js"></script>
    <link href="../startbootstrap/bower_components/bootstrap/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="../startbootstrap/bower_components/metisMenu/dist/metisMenu.min.css" rel="stylesheet">
    <link href="../startbootstrap/dist/css/sb-admin-2.css" rel="stylesheet">
    <link href="../startbootstrap/bower_components/font-awesome/css/font-awesome.min.css" rel="stylesheet" type="text/css">
    <link href="../scripts/css/auto.css" rel="stylesheet">
    <link href="../custom_css/arrow.css" rel="stylesheet">
    <script type="text/javascript" src="./select_view/select_option.js"></script>
    <script type="text/javascript" src="../scripts/auto.js"></script>
    <script type="text/javascript" src="../scripts/city.data.js"></script>
    

</head>
<style type="text/css">
    .header_img{
        width: 100%;
        height: 100%;
        float: right;
        border-radius:50%
    }
    #base_form td{
        padding-bottom: 15px;
    }
    
    #new_address td{
    	padding-bottom: 6px;
    }
    .but {
        float: right;
        text-align: center;
    }
    .but input{background-color:transparent; border:1px solid #fff; border-radius:3px; padding:0 13px; margin-right:30px;}
    .increase{width:240px; height:160px; background-color:#fff; border:2px dashed #cecece; position:relative; margin:0 auto;}
    .inc1{border:4px solid #c1bfc0; height:0; width:126px; border-radius:10px; position:absolute; top:50%; left:50%; margin:-4px 0 0 -63px;}
    .inc2{border:4px solid #c1bfc0; height:126px; width:0; border-radius:10px; position:absolute; top:50%; left:50%; margin:-63px 0 0 -4px;}
    .img_plus{margin-left: 5px;width: 14px;height: 14px;cursor: pointer}
    .img_minus{margin-left: 5px;width: 14px;height: 14px;cursor: pointer}
    #moreInfo_open img:hover{
    	 -moz-transform:scale(1.5,1.5); 
  		 -webkit-transform:scale(1.5,1.5);  
  	     -o-transform:scale(1.5,1.5);  
    }
    #moreInfo_close:hover{
    	 -moz-transform:scale(1.5,1.5); 
  		 -webkit-transform:scale(1.5,1.5);  
  	     -o-transform:scale(1.5,1.5);  
    }
    
</style>
<script type="text/javascript">
    var customer_id = getUrlParamByKey("customer_id");
    var house_id = getUrlParamByKey("house_id");
    var source = getUrlParamByKey("source");
    var user = null;
    var childs = null;
    var emList = null;
    var dict_relation_content = $dict.getDictList('relation_content_resource');
    var dict_relation_content_option = $dict.getDictList('relation_content_option_resource');
    
    $(function(){
    	
        setDict('work_overtime_resource', $("#work_overtime"));
        setDict('customer_job', $("#job"));
        setDict('customer_nationality', $("#nationality"));
        setDict('customer_pet', $("#pet_type"));
        initView();
        loadUpload();
        loadCity();//加载籍贯、户口所在地（city.data.js）
        $('input[name="house_type"]').click(function(){
        	if(!isNewAddress){
        		if($('input[name="house_type"]:checked').val() == 0){
                    hideBuilding();
                    $("#tv_id").val("");
                    $('#tv_name').val("");
                    $('#tv_name-search').children().remove();
                    $('#house_no').val("");
                }else{
                    showBuilding();
                    $("#tv_id").val("");
                    $('#tv_name').val("");
                    $('#tv_name-search').children().remove();
                    $('#house_no').val("");
                }
        	}
            
        }); 
       
    });
    
    function setDict(dicname,resourceName){
        var resourceId = resourceName[0];
        var resource = $dict.getDictList(dicname);
        var option = new Option('请选择', '');
        resourceId.add(option);
        $(resource).each(function(i, element){
            var option = new Option(element.dictText, element.dictCode);
            resourceId.add(option);
        });
    }

    function hideBuilding(){
    	
        $('#building_name').hide();
       
        $('#building_span').hide();
        $("#unit_no").hide();
        
        $("#unit_span").hide();
        $('#span_tv').text('街(道)');
        $("#new_tinvillage_name").text("街(道)");
        $("#new_house_name").text('门牌号');
        $("#building_tr").hide();
        $("#unit_tr").hide();
        $('#house_span').text("门牌号");
    }

    function showBuilding(){
    	
    	$('#building_name').show();
    	$('#building_span').show();
    	$("#unit_no").show();
        $("#unit_span").show();
        $('#span_tv').text('小区');
        $("#new_tinvillage_name").text("小区");
        $("#new_house_name").text('房间号');
        $("#building_tr").show();
        $("#unit_tr").show();
        $('#house_span').text('房间号');
    }

    function initSelectNamesBySid(store_id) {
        doManager("UserManager", "findNamesBySid", "" + store_id,
                function(data, textStatus, XMLHttpRequest) {
                    if (data.result) {
                        var jsonData = $.fromJSON(data.data);
                        emList = jsonData.userList;
                    }
                }, false);
    }

    function initView(){

        doManager('UserManager','getCurrentUserDTO',null,function(data){
            if(data.result){
                var userDto = JSON.parse(data.data)
                user = userDto;
                //initSelectNamesBySid(user.store_id);
                if(user.store_id==null){
                	 //$$.showMessage('提示',"您的账号没有关联门店！");
                }else{
                	getTownByStore(user.store_id);//获取门店所在街道信息
                }
                
            }else{
                $$.showMessage('提示',data.message);
            }
        });

        if(customer_id == null || customer_id == ''){
            addFamily();
            return;
        }
        if(house_id == ''){
            house_id = null;
        }

        doManager('CustomerManager','findCustomerIdAndHouseId',[customer_id,house_id],function (data, textStatus, XMLHttpRequest){
            if(data.result){
                var customer = JSON.parse(data.data);
                
                //查询更多信息
                 doManager('CustomerDataManager','getCustomerDataByCustomerId',[customer.id],function(data){
		            if(data.result){
		            	if(data.data!=null&&data.data!="null"){
		            		var customerData = JSON.parse(data.data);
			                initCustomerData(customerData);
		            	}
		            	
		            }else{
		                $$.showMessage('提示',data.message);
		            }
		        });
                viewValue(customer);
                
            }else{
                $$.showMessage("提示",data.message);
            }
        });
    }

    function viewValue(customer){
    	$("#otherJob").hide();
    	$("#otherPet").hide();
        setFormSimpleData(customer);
        
        
        
       	$("#nationality option").each(function(t,e){
           	var national = $(this).text();
           	if(national.indexOf(customer.nationality)>=0){
           		$(this).attr("selected",true);
           	}
        });
       
        if(customer.job!=null){
        	
        	if(customer.job.indexOf("99_")==0){
            	$("#job option:last").attr("selected",true);
            	$("#otherJob").show();
            	$("#otherJob").val(customer.job.substring(3,customer.job.length));
            
            }else{
            	 $("#job option").each(function(t,e){
                 	var job = $(this).text();
                 	if(job==customer.job){
                 		$(this).attr("selected",true);
                 	}
                 });
            }
        }else{
        	$("#otherJob").hide();
        }
        
        
       if(customer.pet_type!=null){
    	   if(customer.pet_type.indexOf("99_")==0){
           	$("#pet_type option:last").attr("selected",true);
           	$("#otherPet").show()
           	$("#otherPet").val(customer.pet_type.substring(3,customer.pet_type.length));
           	
           }else{
           	 $("#pet_type option").each(function(t,e){
                	var pet_type = $(this).text();
                	if(pet_type==customer.pet_type){
                		$(this).attr("selected",true);
                	}
                });
           }
       }else{
    	   
    	   $("#otherPet").hide();
       }
       
       
        childs = customer.childs;
        $('input[name="sex"][value="' + customer.sex + '"]').attr('checked', 'checked');
        $('input[name="house_property"][value="' + customer.house_property + '"]').attr('checked', 'checked');
        if(customer.customer_address != null){
            $('input[name="house_type"][value="' + customer.customer_address.house_type + '"]').attr('checked', 'checked');
            $('#tv_id').val(customer.customer_address.tv_id);
            $('#tv_name').val(customer.customer_address.tv_name);

            $('#building_id').val(customer.customer_address.building_id);
            $('#building_name').val(customer.customer_address.building_name);
            $('#unit_no').val(customer.customer_address.unit_no);
            $('#house_no').val(customer.customer_address.house_no);

            $('#house_area').val(customer.customer_address.house_area);
            $('#house_style').val(customer.customer_address.house_style);
            $('#house_toward').val(customer.customer_address.house_toward);
            $('#house_pic').text(customer.customer_address.house_pic);
            $('#house_id').val(customer.customer_address.house_id);
            $('#house_style_id').val(customer.customer_address.house_style_id);
            if(customer.customer_address.house_type == 0){
                hideBuilding();
            }else{
                showBuilding();
            }
        }

        $('#cus_pic').attr('src',customer.cus_pic);
        $('#customer_pic').val(customer.customer_pic);
        $('#family_div').find(".panel-primary").remove();
        //$('#relation_div').find(".panel-primary").remove();
        initFamily();

        if(customer.childs != null && customer.childs.length > 0){
            $(customer.childs).each(function(i, family) {
                addFamily(family);
            });
        }else{
            addFamily();
        } 

        /* if(customer.relations!= null && customer.relations.length > 0){
            $(customer.relations).each(function(i, relation) {
                addRelation(relation);
            });
        }else{
            addRelation();
        } */
    }

    function initFamily() {
        var $tbody = $('#relationTable').find('tbody');
        $tbody.children().remove();
        $(childs).each(function(index,element){
            if(index > 4){
                return;
            }
            $tbody.append('<tr></tr>');
            var tr = $tbody.find('tr:last');
            tr.append('<td>'+element.family_relation+'</td>');
            tr.append('<td>'+element.family_name+'</td>');
            tr.append('<td>'+element.family_phone+'</td>');
            tr.append('<td>'+element.family_age+'</td>');
        });
    }

    function addFamily(family) {
        if(typeof(family) == 'undefined') {
            family = {
                family_relation: '',
                family_name: '',
                family_phone: '',
                family_age: ''
            };
        }
        var $div_parent = $('#family_div');
        var $div_btn = $div_parent.find('#div_btn');
        $div_btn.before('<div style="float: left;width: 30%;margin-top: 20px;margin-right: 2%" class="panel panel-primary"></div>');
        var $div_content = $div_parent.find('.panel-primary:last');
        $div_content.append('<div class="panel-heading">家庭成员<span class="but"><input type="button" value="删除"/></span></div><div class="panel-body">' +
                '<table cellpadding="0" cellspacing="0" style="min-width: 95%;margin: 10px 0; width: auto">' +
                '<tr><td>成员称谓</td><td>' +
                '<select name="family_relation" type="text" class="form-control" style="width: 90%; margin-left:10px;"></select></td></tr>' +
                '<tr><td>成员姓名</td>' +
                '<td><input name="family_name" type="text" class="form-control" style="width: 90%; margin-left:10px;"  value="'+family.family_name+'"/></td></tr>' +
                '<tr><td>成员电话</td>' +
                '<td><input name="family_phone" type="text" class="form-control"  style="width: 90%; margin-left:10px;" maxlength="11" value="'+family.family_phone+'" /></td></tr>' +
                '<tr><td>成员年龄</td>' +
                '<td>' +
//                '<div class="input-group" style="width: 90%; margin-left:10px;">' +
                '<input name="family_age" type="text" class="form-control" style="width: 90%; margin-left:10px;" maxlength="3"  value="'+family.family_age+'" />' +
//                '<span class="input-group-addon">岁</span></div>' +
                '</td></tr></table></div>');
        
        var $select = $div_content.find("select[name='family_relation']");
        $select.append('<option value="">请选择</option>');
        $select.append('<option value="配偶">配偶</option>');
        $select.append('<option value="祖父母">祖父母</option>');
        $select.append('<option value="父母">父母</option>');
        $select.append('<option value="子女">子女</option>');
        $select.append('<option value="孙儿">孙儿</option>');
        $select.append('<option value="其他">其他</option>');

        $select.val(family.family_relation);

        $div_content.find("input[name='family_age']").keyup(function () {
            $(this).val( $(this).val().replace(/\D/g,''));
        });
        
        $div_content.find("input[name='family_phone']").keyup(function () {
            $(this).val( $(this).val().replace(/\D/g,''));
        });

        $div_content.find("input[type='button']").click(function(){
            var flag = false;
            $div_content.find('.form-control').each(function(){
                var value = $(this).val();
                if(!flag && value != null && value != ""){
                    flag = true;
                }
            });
            if(flag){
                $$.showConfirm("提示","包含已输入的数据是否删除？",function () {
                    $div_content.remove();
                });
            }else{
                $div_content.remove();
            }
        });
    }

    /* function addRelation(relation) {
        var isedit = false;
        if(typeof(relation) == 'undefined') {
            isedit = true;
            relation = {
                id:'',
                employee_no:user.employeeId,
                employee_name:user.name,
                relation_date:new Date().format('yyyy-MM-dd'),
                childs:[]
            }
        }else{
            relation.relation_date = new Date(relation.relation_date).format('yyyy-MM-dd');
        }
        var $div_parent = $('#relation_div');
        var $div_btn = $div_parent.find('#div_relation_btn');
        $div_btn.before('<div style="float: left;width: 45%;margin-top: 20px;margin-right: 2%;height: 500px;overflow: auto;" class="panel panel-primary"></div>');
        var $div_content = $div_parent.find('.panel-primary:last');
        var html = '<div class="panel-heading">拜访记录<input name="relation_id" type="hidden" value="'+relation.id+'"/>'+
        (isedit == true?'<span class="but"><input type="button" value="删除"></span>':'')+
        '</div><div class="panel-body"><table cellpadding="0" cellspacing="0" style="min-width: 95%;margin: 10px 0; width: auto"> ' +
        '<tr><td width="35%">拜访国安侠</td>' +
        '<td width="65%"><select name="employee_no" type="text" class="form-control" style="width: 90%; margin-left:10px;" ' +
        (isedit == true?'':'disabled')+'></select></td></tr>' +
        '<tr><td>拜访方式</td>' +
        '<td><select name="relation_type" type="text" class="form-control" style="width: 90%; margin-left:10px;" ' +
        (isedit == true?'':'disabled')+'></select></td></tr>' +
        '<tr><td>拜访时间</td>' +
        '<td><input name="relation_date" type="text" validate="formatDate:true"  yearRange=\"-10:+10\" style="width: 90%; margin-left:10px;display: inline;" value="'+relation.relation_date+'" readonly ' +
        (isedit == true?'class="form-control pmsDateField"':'class="form-control"')+'></td></tr>' +
        '</table></div></div>';
        $div_content.append(html);
        $form.initFormStyle();
        var $table = $div_content.find('table');
        $(dict_relation_content).each(function(index,element){
            $table.append('<tr><td colspan="2">'+element.dictText
                    +(isedit == true?'<img src="../images/badge_plus_16px.png" class="img_plus">':'') +
                    '<input type="hidden" name="dictCode" value="'+element.dictCode+'">'+
                    '</td></tr>');
            var $code = $table.find('input[name="dictCode"]:last');
            var $img = $table.find('.img_plus:last');
            $(relation.childs).each(function(i,content){
                if(content.content_code != element.dictCode){
                    return;
                }
                addRow($table,$code,isedit,element.dictCode,content);
            });
            if(isedit){
                $img.click(function(){
                    var dcode = $img.next('input').val();
                    addRow($table,$img,isedit,dcode,null,null);
                });
            }
        });

        function addRow($table,$code,isedit,dictCode,content){
            if(content == null){
                content = {
                    id : '',
                    option_code : '',
                    content : ''
                };
            }
            var str_select_name = 'option'+dictCode;
            var str_input_name = 'input'+dictCode;
            var $tr = $code.parent().parent();
            var html = '<tr><td>' +
                    '<select name="'+str_select_name+'" class="form-control"' +
                    (isedit == true?'':'disabled') +'></select>' +
                    '<input type="hidden" name="content_id" value="'+content.id+'">' +
                    '</td><td>' +
                    '<input name="'+str_input_name+'" type="text" class="form-control" style="width: 90%;display:inherit ; margin-left:10px;" maxlength="120" value="'+ content.content + '"' +
                    (isedit == true?'':'disabled') +'>' +
                    (isedit == true?'<img src="../images/minus_16px.png" class="img_minus">':'') +
                    '</td></tr>';
            $tr.after(html);
            var $current_tr = $tr.next('tr');
            var $select_option = $current_tr.find('select[name="'+str_select_name+'"]:last');
            dict_relation_content_option.sort(function(a,b){
                return a.dictCode-b.dictCode
            });
            $(dict_relation_content_option).each(function(j,dict){
                if(dict.serialNumber == dictCode){
                    $select_option.append('<option value="'+dict.dictCode+'">'+dict.dictText+'</option>');
                }
            });
            if(isedit){
                var $img_minus = $current_tr.find('.img_minus:last');
                $img_minus.click(function(){
                    $current_tr.remove();
                });
            }

            if(content.option_code != ''){
                $select_option.val(content.option_code);
            }
        }

        var $select = $div_content.find('select[name="employee_no"]');
        $select.append('<option value="">请选择</option>');
        $(emList).each(function(index,element){
            $select.append('<option value="'+element.employeeId+'">'+element.name+'</option>');
        });
        $select.val(relation.employee_no);


        var $select_type = $div_content.find('select[name="relation_type"]');
        $select_type.append('<option value="电话">电话</option>');
        $select_type.append('<option value="微信">微信</option>');
        $select_type.append('<option value="客户到店">客户到店</option>');
        $select_type.append('<option value="面对面（上门）">面对面（上门）</option>');
        $select_type.append('<option value="面对面（混片儿）">面对面（混片儿）</option>');
        $select_type.append('<option value="其他">其他</option>');
        $select_type.val(relation.relation_type);

        $div_content.find("input[type='button']").click(function(){
            var flag = false;
            $div_content.find('.form-control').each(function(){
                var value = $(this).val();
                if(!flag && value != null && value != ""){
                    flag = true;
                }
            });
            if(flag){
                $$.showConfirm("提示","包含已输入的数据是否删除？",function () {
                    $div_content.remove();
                });
            }else{
                $div_content.remove();
            }
        });
        $form.initFormStyle();
    } */

    function doShowRelation(){
        $('#family_div').dialog({
            bgiframe : true,
            title : "提示",
            width : 900,
            height : 600,
            buttons : {
                "确定" : function() {
                    var flag = getChilds();
                    if(flag){
                        $(this).dialog("close");
                    }
                },
                "取消" : function() {
                    $(this).dialog("close");
                }
            },
            modal : true
        });
    }

    function getChilds(){
        var ulArray = $('#family_div').find('.panel-primary');
        var familyArray = new Array();
        var allFamily = new Array();
        for(var i = 0;i < ulArray.length;i++){
            var str_family_relation = $(ulArray[i]).find('select[name="family_relation"]').val();
            var str_family_name = $(ulArray[i]).find('input[name="family_name"]').val();
            var str_family_phone = $(ulArray[i]).find('input[name="family_phone"]').val();
            var str_family_age = $(ulArray[i]).find('input[name="family_age"]').val();

            if(!checkValue(str_family_relation) || !checkValue(str_family_name) ||
                    !checkValue(str_family_age)) {
                $$.showMessage('提示','请输入完整的家庭成员信息，或删除不完整的信息');
                return false;
            }
            if(checkValue(str_family_phone)) {
                if(!/^\d{11}$/.test(str_family_phone)) {
                    $$.showMessage('提示',"请输入正确的家庭成员电话,电话请加区号。");
                    return false;
                }
            }

            var family = {
                family_relation: str_family_relation,
                family_name: str_family_name,
                family_phone: str_family_phone,
                family_age: str_family_age
            };
           	var info = str_family_relation+"_"+str_family_name+"_"+str_family_phone+"_"+str_family_age;
           
           	allFamily.push(info);
           	
            familyArray.push(family);
            
        }
        
        var nary=allFamily.sort(); 
       
		for(var i=0;i<nary.length;i++){
			if (nary[i]==nary[i+1]){ 

				 $$.showMessage('提示',"家庭成员出现重复！");
				return false;
			} 
		}
        
        childs = familyArray;
        
        initFamily();
        return true;
    }

    function doBack(v){
    	if(source=="dataCard"){
    		window.history.go(-1);
    	}else if(v==undefined){
    		window.location.href= encodeURI(getRootPath()+"/data_access/customer_address_list.html?customer_name=&customer_mobilephone=");
    	}else{
        	window.location.href= encodeURI(getRootPath()+"/data_access/customer_address_list.html?customer_name="+v.name+"&customer_mobilephone="+v.mobilephone);

    	}
        
    }

    function doMessage(){
        var employee_no = $('#employee_no').val();
        if(employee_no != null && employee_no != ''){
            doManager('CustomerManager','getStoreKepper',[employee_no],function(data){
                if(data.result){
                	if(data.data!=null&&data.data!="null"){
                		var customer = JSON.parse(data.data);
                		if(customer.employeeId==user.employeeId){
                			doSave();
                		}else{
                			if(employee_no != user.employeeId){
                                $$.showConfirm('提示','正在修改国安侠 '+employee_no+' 的数据，需通知审核后才能保存入数据库！',function(){
                                    doSave();
                                });
                            }else{
                                doSave();
                            }
                		}
                		
                	}
                	
                }else{
                    $$.showMessage('提示',data.message);
                }
            });
        }else{
        	 doSave();
        }
  
        
    }

    function doSave(){

        $('#btnSave').val("保存中........");
        $('#btnSave').attr("disabled",true);
//        var ulArray = $('#family_div').find('.panel-primary');
//        var familyArray = new Array();
//        for(var i = 0;i < ulArray.length;i++){
//            var str_family_relation = $(ulArray[i]).find('select[name="family_relation"]').val();
//            var str_family_name = $(ulArray[i]).find('input[name="family_name"]').val();
//            var str_family_phone = $(ulArray[i]).find('input[name="family_phone"]').val();
//            var str_family_age = $(ulArray[i]).find('input[name="family_age"]').val();
//
//            if(!checkValue(str_family_relation) || !checkValue(str_family_name) ||
//                    !checkValue(str_family_age)) {
//                $$.showMessage('提示','请输入完整的家庭成员信息，或删除不完整的信息');
//                return;
//            }
//            if(checkValue(str_family_phone)) {
//                if(!/^\d{11}$/.test(str_family_phone)) {
//                    $$.showMessage('提示',"请输入正确的家庭成员电话,电话请加区号。");
//                    return;
//                }
//            }
//
//            var family = {
//                family_relation: str_family_relation,
//                family_name: str_family_name,
//                family_phone: str_family_phone,
//                family_age: str_family_age
//            };
//            familyArray.push(family);
//        }

        var relationArray = new Array();
        //var relationElementArray =  $('#relation_div').find('.panel-primary');
        /* for(var i = 0;i < relationElementArray.length;i++){
            var str_employee_no = $(relationElementArray[i]).find('select[name="employee_no"] option:selected').val();
            var str_employee_name = $(relationElementArray[i]).find('select[name="employee_no"] option:selected').text();
            var str_relation_date = $(relationElementArray[i]).find('input[name="relation_date"]').val();
            var str_relation_type = $(relationElementArray[i]).find('select[name="relation_type"] option:selected').val();
            var str_id = $(relationElementArray[i]).find('input[name="relation_id"]').val();
            var content_childs = [];
            $(dict_relation_content).each(function(index,element){
                $(relationElementArray[i]).find('select[name="option'+element.dictCode+'"]').each(function(){
                    var $current_tr = $(this).parent().parent();
                    var str_content_id = $current_tr.find('input[name="content_id"]').val();
                    var str_content = $current_tr.find('input[name="input'+element.dictCode+'"]').val();
                    var str_option_code = $(this).find('option:selected').val();
                    if(checkValue(str_content)){
                        var obj = {
                            id:str_content_id,
                            relation_id:str_id,
                            content_code:element.dictCode,
                            option_code:str_option_code,
                            content:str_content
                        }
                        content_childs.push(obj);
                    }
                });
            });

            if(!checkValue(str_employee_no) || content_childs.length == 0) {
                continue;
            }

//            if(checkValue(str_relation_type) && !checkValue(str_product_services) &&
//                    !checkValue(str_cultural_activity) && !checkValue(str_common_activity)) {
//                $$.showMessage("提示","拜访记录中有选择拜访国安侠但未填写拜访内容的数据。");
//                return false;
//            }

            if(!checkValue(str_relation_type)  && content_childs.length != 0) {
                $$.showMessage("提示","拜访记录中有未选择拜访方式的选项。");
                setBtnEnble();
                return;
            }

            var relation = {
                id:str_id,
                employee_no: str_employee_no,
                employee_name: str_employee_name,
                relation_date: str_relation_date,
                relation_type:str_relation_type,
                childs:content_childs
            };
            relationArray.push(relation);
        } */

        var customer = getFormSimpleData('div_customer');
        if(customer.create_user_id == null){
            customer.create_user_id = user.id;
            customer.create_user  = user.name;
        }
        customer.customer_pic = $('#customer_pic').val();
        customer.update_user_id = user.id;
        customer.update_user  = user.name;
        customer.employee_no = user.employeeId;
        customer.childs = childs;
        customer.relations = relationArray;
        customer.job = $("#job option:selected").text()=="请选择"?"":$("#job option:selected").text();
        customer.pet_type = $("#pet_type option:selected").text()=="请选择"?"":$("#pet_type option:selected").text();
        customer.nationality = $("#nationality option:selected").text()=="请选择"?"":$("#nationality option:selected").text();
        var otherJob = $("#otherJob").val();
        var otherPet = $("#otherPet").val();
        if(customer.name.replace(/^\s+|\s+$/g, '') == '' || customer.name == null) {
            $$.showMessage('提示','请输入用户名称');
            setBtnEnble();
            return;
        }

        if(!checkValue(customer.mobilephone)&&customer.mobilephone.replace(/^\s+|\s+$/g, '')=='') {
            $$.showMessage('提示',"请输入电话号码。");
            setBtnEnble();
            return;
        }

        if(!/^\d{11}$/.test(customer.mobilephone)) {
            $$.showMessage('提示',"请输入正确的电话号码。");
            setBtnEnble();
            return;
        }
        
        if(customer.job=="其他"&&otherJob==""){
        	 $$.showMessage('提示',"请输入其他职业信息");
             setBtnEnble();
             return;
        }else if(customer.job=="其他"&&otherJob!=""){
        	if(otherJob.length>20){
        		 $$.showMessage('提示',"职业信息长度限制在20以内");
                 setBtnEnble();
                 return;
        	}else{
        		customer.job = "99_"+otherJob;
        	}
        	 
             
        }
        
        if(customer.pet_type=="其他"&&otherPet==""){
       	 $$.showMessage('提示',"请输入其他宠物信息");
            setBtnEnble();
            return;
        }else if(customer.pet_type=="其他"&&otherPet!=""){
        	if(otherPet.length>20){
        		$$.showMessage('提示',"宠物信息长度限制在20以内");
                setBtnEnble();
                return;
        	}else{
        		customer.pet_type = "99_"+otherPet;
        	}
        	
        }
        if(checkValue(customer.family_num)){
            if(checkValue(customer.preschool_num) && parseInt(customer.family_num) < parseInt(customer.preschool_num)){
                $$.showMessage('提示','家庭人员人口数必须大于学龄前人数和未成年人数的总和');
               
                setBtnEnble();
                return;
            }
            if(checkValue(customer.minor_num) && parseInt(customer.family_num) < parseInt(customer.minor_num)){
                $$.showMessage('提示','家庭人员人口数必须大于学龄前人数和未成年人数的总和');
                
                setBtnEnble();
                return;
            }
            if(checkValue(customer.preschool_num) && checkValue(customer.minor_num) && parseInt(customer.family_num) < (parseInt(customer.preschool_num) + parseInt(customer.minor_num))){
                $$.showMessage('提示','家庭人员人口数必须大于学龄前人数和未成年人数的总和');
               
                setBtnEnble();
                return;
            }
        }
       
        var tv_name = $('#tv_name').val();
        var house_type = $('input[name="house_type"]:checked').val();
        var house_pic = $('#house_pic').text();
        var building_name = $('#building_name').val();
        var unit_no = $('#unit_no').val();
        var house_no = $('#house_no').val();
        if(house_type == '0'){
            house_pic = null;
        }
        if(tv_name != '' && tv_name != null){
           
           
            var tv_id = $('#tv_id').val();
            if((tv_id == "" || tv_id == null)){
                setBtnEnble();
                $$.showConfirm("提示","地址库中无此小区无法添加,是否新增？",function () {
                   show_new_address();
                });
               // $$.showMessage('提示',"地址库中无此小区无法添加。");
                return;
            }
			
          
            if(((building_name == "" || building_name == null)||(house_no == "" || house_no == null)
                || (unit_no == "" || unit_no == null)) && house_type == '1'){
                setBtnEnble();
                $$.showMessage('提示',"请完整填写地址信息。");
                return;
            }
            
            if((house_no == "" || house_no == null)&&house_type == '0'){
            	setBtnEnble();
                $$.showMessage('提示',"请完整填写地址信息。");
                return;
            }

            var address ="";
            if(house_type == 1){
            	
                address = tv_name+"小区" + building_name + "号楼"+ unit_no+ "单元" + house_no + "号";
            }else{
            	address = tv_name+"街(道)" +house_no+ "号";
            }
           
            customer.address = address;
            customer.customer_address = {
                tv_id:$('#tv_id').val(),
                tv_name:tv_name,
                building_id:$('#building_id').val(),
                building_name:building_name,
                house_no:house_no,
                unit_no:unit_no,
                house_id:$('#house_id').val(),
                house_style_id:$('#house_style_id').val(),
                house_toward:$('#house_toward').val(),
                house_area:$('#house_area').val(),
                house_pic:house_pic,
                house_style:$('#house_style').val(),
                house_type:house_type,
                update_user_id:user.id,
                update_user:user.name,
				store_id:user.store_id
            };
        }
        
            var customerData = new Object();
            customerData.id=$("#customerData_id").val();
      		customerData.nationality=$("#nationality_gj").val();
      		customerData.native_place_pro=$("#native_place_city").val();
      		customerData.native_place_city=$("#native_place_pro").val();
      		customerData.local_city=$("#local_city").val();
      		customerData.local_pro=$("#local_pro").val();
      		customerData.health_condition=$("#health_condition").val();
      		customerData.marital_status=$("#marital_status").val();
      		customerData.degree_of_education=$("#degree_of_education").val();
      		customerData.school_name=$("#school_name").val();
      		customerData.is_car=$('input[name="is_car"]:checked').val();
      		customerData.automobile_brand=$("#automobile_brand").val();
      		customerData.money_manage=$("#money_manage").val();
      		customerData.character_data=$("#character_data").val();
      		customerData.household_income=$("#household_income").val();
      		customerData.shopping_channel=$("#shopping_channel").val();
      		customerData.hobby_one=$("#hobby_one").val();
      		customerData.hobby_two=$("#hobby_two").val();
            customerData.hobby_three=$("#hobby_three").val();
            customerData.employee_no= user.employeeId;
            customerData.store_id=user.store_id;
            
            var customerDataIsNull = true;
            if(customerData.nationality!=null&&customerData.nationality!=""){
            	customerDataIsNull = false;
            }
            
			if(customerData.native_place_pro!=null&&customerData.native_place_pro!=""){
				customerDataIsNull = false;
            }
			
			if(customerData.local_city!=null&&customerData.local_city!=""){
				customerDataIsNull = false;
            }
			
			if(customerData.local_pro!=null&&customerData.local_pro!=""){
				customerDataIsNull = false;
            }
			if(customerData.health_condition!=null&&customerData.health_condition!=""){
				customerDataIsNull = false;
            }
			if(customerData.marital_status!=null&&customerData.marital_status!=""){
				customerDataIsNull = false;
            }
			if(customerData.degree_of_education!=null&&customerData.degree_of_education!=""){
				customerDataIsNull = false;
            }
			if(customerData.school_name!=null&&customerData.school_name!=""){
				customerDataIsNull = false;
            }
			if(customerData.automobile_brand!=null&&customerData.automobile_brand!=""){
				customerDataIsNull = false;
            }
			if(customerData.money_manage!=null&&customerData.money_manage!=""){
				customerDataIsNull = false;
            }
			if(customerData.character_data!=null&&customerData.character_data!=""){
				customerDataIsNull = false;
            }
			if(customerData.household_income!=null&&customerData.household_income!=""){
				customerDataIsNull = false;
            }
			if(customerData.shopping_channel!=null&&customerData.shopping_channel!=""){
				customerDataIsNull = false;
            }
			if(customerData.hobby_one!=null&&customerData.hobby_one!=""){
				customerDataIsNull = false;
			}
			if(customerData.hobby_two!=null&&customerData.hobby_two!=""){
				customerDataIsNull = false;
			}
			if(customerData.hobby_three!=null&&customerData.hobby_three!=""){
				customerDataIsNull = false;
			}
            
			if(customerDataIsNull){
				customerData=null;
			}
            
        doManager('CustomerManager', 'saveCustomerAndAddress', [customer,customerData], function(data) {
            if(data.result){
                setBtnEnble();
                $$.showMessage('提示','保存成功！',function () {
                	var nameAndPhone = JSON.parse(data.data);
                    doBack(nameAndPhone);
                });
            }else{
                $$.showMessage('提示','保存失败！message:\n'+data.message);
            }
        });
    }

    function setBtnEnble(){
        $('#btnSave').val("保存");
        $('#btnSave').attr("disabled",false);
    }

    var setHousePic = function(json){
        $('#house_pic').text(json.pic_name);
    }
    function showHouse_pic(){
        var tv_name = $('#tv_name').val();
        var building_name = $('#building_name').val();
        var house_no = $('#house_no').val();
        if(!checkValue(tv_name)&&!checkValue(building_name)&&!checkValue(house_no)){
            $$.showMessage('提示','请输入完整的家庭住址');
            return;
        }
        var house_style = $('#house_style').val();
        var house_toward = $('#house_toward').val();
        if(!checkValue(house_style)&&!checkValue(house_toward)){
            $$.showMessage('提示','请输入完整的户型信息');
            return;
        }
        var fname = tv_name + "_" + building_name + "_" + house_no +  "_" + house_style + "_" + house_toward;
        var obj = {
            tv_id:$('#tv_id').val(),
            fname:fname
        }
        showSelectHousePic(setHousePic,obj);
    }

    function checkValue(value){
        if(value == null || value == ''){
            return false;
        }
        return true;
    }

    function loadUpload(){
        var url = getRootPath()+ "/fileUpload.action?img_type=1&file_name=user_image";
        var elementsId = ['uploader_pic'];
        $('#uploader_pic').change(function(){
            $.ajaxFileUpload({
                url: url,
                type: 'post',
                secureuri: false, //一般设置为false
                fileElementId: elementsId, // 上传文件的id、name属性名
                dataType: 'JSON', //返回值类型，一般设置为json、application/json
                success: function(data, status){
                    data = JSON.parse(data);
                    if(data.result){
                        var pmsFile = JSON.parse(data.data);
                     //$('#cus_pic').attr('src',getFilePath()+pmsFile.filePath);
                       $('#cus_pic').attr('src',"https://imagedata.guoanshequ.com/file_manager/"+pmsFile.filePath); 
                       $('#customer_pic').val(pmsFile.name);
                    }else{
                        $$.showMessage('提示',data.message);
                    }
                },
                error: function(data, status, e){
                    $$.showMessage("提示",e);
                }
            });
        });
    }
    
    
    function show_new_address(){
	    $("#tin_village").val($("#tv_name").val());
        $("#new_building").val($("#building_name").val());
        $("#new_unit_no").val($("#unit_no").val());
        $("#new_house_no").val($("#house_no").val());
   	    $('#new_address_div').dialog({
              bgiframe : true,
              title : "家庭住址",
              width : 400,
              height : 423,
              buttons : {
                  "确定" : function() {
                	  var town = $("#town_id").val();
                	  if(town==null||town==""){
                		  $$.showMessage('提示',"街道不存在，请到地采信息管理中维护！");
                		  
                		  return;
                	  }
                	  
                	  var village = $("#village_id").val();
                	  if(village==null||village==""){
                		  $$.showMessage('提示',"社区不存在，请到地采信息管理中维护！");
                		  
                		  return;
                	  }
                	  
                     checkAndSaveAddress();
                     
                     
                  },
                  "取消" : function() {
                      $(this).dialog("close");
                  }
              },
              modal : true
          });
    }
    
    //检查并保存新地址
    var isNewAddress=false;
    function checkAndSaveAddress(){
    	
    	var tv = new Object();
    	tv.town_id=$("#town_id").val();
    	tv.village_id = $("#village_id").val();
    	tv.name=$("#tin_village").val();
    	//tv.tinyvillage_type  = $('input[name="house_type"]:checked').val()=="0"?0:1;
    	doManager('TinyVillageManager','getTinyVilageByNameByTiny',tv,function(data){
              if(data.result){
              	
              	var tinVillage = JSON.parse(data.data)
                if(tinVillage!=null){
                	 $$.showMessage('提示',"此小区已存在！");
                	 
                	 return;
                }else{
                	var houseType = $("input[name='house_type']:checked").val();
                	if(houseType=="1"){//楼房
                		var building_name = $("#new_building").val();
                		var unit_no = $("#new_unit_no").val();
                		var house_no = $("#new_house_no").val();
                		var tv_name = $("#tin_village").val();
                		if(tv_name.replace(/^\s+|\s+$/g, '')==""){
               			 $$.showMessage('提示',"请输入小区！");
               			 
               			 return;
               			}
                		if(building_name.replace(/^\s+|\s+$/g, '')==""){
                			 $$.showMessage('提示',"请输入楼号！");
                			 
                			 return;
                		}
                		
                		if(unit_no.replace(/^\s+|\s+$/g, '')==""){
               			 $$.showMessage('提示',"请输入单元号！");
               			 
               			 return;
               			}
                		
                		if(house_no.replace(/^\s+|\s+$/g, '')==""){
               			 $$.showMessage('提示',"请输入房间号！");
               			 
               			 return;
               			}
                		
                	}else if(houseType=="0"){//平房
                		var house_no = $("#new_house_no").val();
                		var tv_name = $("#tin_village").val();
                		if(tv_name.replace(/^\s+|\s+$/g, '')==""){
               			 $$.showMessage('提示',"请输入街(道)！");
               			 
               			 return;
               			}
                		if(house_no.replace(/^\s+|\s+$/g, '')==""){
                  			 $$.showMessage('提示',"请输入门牌号！");
                  			 
                  			 return;
                  		}
                	}
                	
                	 var customer = new Object();
                	 customer.customer_address = {
                            
                			 town_id:$("#town_id").val(),
                	         village_id:$("#village_id").val(),
                	         tv_name:$("#tin_village").val(),
                	         tv_address:$("#tin_village_address").val(),
                             building_id:$('#building_id').val(),
                             building_name:$("#new_building").val(),
                             house_no:$("#new_house_no").val(),
                             unit_no:$("#new_unit_no").val(),
                             house_type:$("input[name='house_type']:checked").val(),
                             update_user_id:user.id,
                             update_user:user.name,
                             store_id:user.store_id
                         };
                	
                	 var index = layer.load(0,{
                		  shade: [0.2,'#333'] 
                		});
                	doManager('ViewAddressCustomerManager','saveOrUpdateCustomerAddressInfo',customer,function(data){
                		if(data.result){
                			var addressCustomer = JSON.parse(data.data)
                			
                			$("#tv_id").val(addressCustomer.tv_id);
                			$('#building_id').val(addressCustomer.building_id);
                			$('#house_id').val(addressCustomer.house_id);
                			
                			$("#tv_name").val(addressCustomer.tv_name);
                			$("#tv_name").attr("disabled","disabled");
                			$("#building_name").val(addressCustomer.building_name);
                			$("#building_name").attr("disabled","disabled");
                			$("#unit_no").val(addressCustomer.unit_no);
                			$("#unit_no").attr("disabled","disabled");
                			$("#house_no").val(addressCustomer.house_no);
                			$("#house_no").attr("disabled","disabled");
                			$("input[name='house_type']:not(:checked)").attr("disabled","disabled");
                			isNewAddress=true;
                			layer.closeAll();
                			
                			$('#new_address_div').dialog("close");
                			
                		}else{
                			layer.closeAll();
                			 $$.showMessage("提示",data.message);
                			 
                			 
                		}
                		 
                	});
                }
              	
              }else{
            	  layer.closeAll();
                  $$.showMessage("提示",data.message);
                 
              }
              
             
          });
      	
    
    }
    
   
    function getTownByStore(storeId){
    	
        doManager('TownManager','getTownByStore',[storeId],function(data){
            if(data.result){
            	
            	var town = JSON.parse(data.data);
                $("#city_id").val(town.cityId);
            	$("#town_name").val(town.name);
            	$("#town_id").val(town.id);
            	
            }else{
                $$.showMessage("提示",data.message);
            }
        });
    	
    }
    
    //展开更多信息
  function  openMoreInfo(){
	  $('#moreInfo').css("display","inline");
	  $("#moreInfo_open").css("display","none");
	  document.body.scrollTop = document.body.scrollHeight;
  }
    
  function closeMoreInfo(){
	  $('#moreInfo').css("display","none");
	  $("#moreInfo_open").css("display","inline");
  }  
   
  //加载户籍，籍贯 cityData在city.data.js中
  function loadCity(){
	  var allShowCity  = cityData;//北京
	  var allShowCountry = cityData[0].children;//北京所辖的区县
	  
	  $(allShowCity).each(function(i,v){
		  $("#native_place_pro").append("<option value='"+cityData[i].text+"'>"+cityData[i].text+"</option>");
		  $("#local_pro").append("<option value='"+cityData[i].text+"'>"+cityData[i].text+"</option>");
	  })
	 
  }
  
  //设置籍贯县区
  function setNativeCity(){
	  $("#native_place_city option").remove();
	  $("#native_place_city").append("<option value=''>请选择</option>");
	  var selectedPro = $("#native_place_pro").val();
	  for(var i=0;i<cityData.length;i++){
		  if(selectedPro==cityData[i].text){
			  
			  $(cityData[i].children).each(function(i,v){
		 		  $("#native_place_city").append("<option value='"+v.text+"'>"+v.text+"</option>");
		 	  });
			  return;
		  }
	  }
  }
  //设置户口县区
  function setLocalCity(){
	  $("#local_city option").remove();
	  $("#local_city").append("<option value=''>请选择</option>")
	  var selectedPro = $("#local_pro").val();
	  
	  for(var i=0;i<cityData.length;i++){
		  if(selectedPro==cityData[i].text){
			  $(cityData[i].children).each(function(i,v){
		 		  $("#local_city").append("<option value='"+v.text+"'>"+v.text+"</option>");
		 	  });
			  return;
		  }
	  }
  }
    //初始更多信息
  function initCustomerData(customerData){
    	$("#customerData_id").val(customerData.id);
	    $("#nationality_gj").val(customerData.nationality);
		$("#native_place_pro").val(customerData.native_place_city);
		setNativeCity();
		$("#native_place_city").val(customerData.native_place_pro);
		$("#local_pro").val(customerData.local_pro);
		setLocalCity();
		$("#local_city").val(customerData.local_city);
		$("#health_condition").val(customerData.health_condition);
		$("#marital_status").val(customerData.marital_status);
		$("#degree_of_education").val(customerData.degree_of_education);
		$("#school_name").val(customerData.school_name);
		if(customerData.is_car==0){
			$("#is_car_y").attr("checked","checked");
		}else{
			$("#is_car_n").attr("checked","checked");
			$("#automobile_brand").attr("readonly","readonly");
		}
		
		
		$("#automobile_brand").val(customerData.automobile_brand);
		$("#money_manage").val(customerData.money_manage);
		$("#character_data").val(customerData.character_data);
		$("#household_income").val(customerData.household_income);
		$("#shopping_channel").val(customerData.shopping_channel);
		$("#hobby_one").val(customerData.hobby_one);
		$("#hobby_two").val(customerData.hobby_two);
        $("#hobby_three").val(customerData.hobby_three);
  }
  
  function showOtherPet(){
	  var pet = $("#pet_type option:selected").text();
	  $("#otherPet").val("");
	  
	  if(pet=="其他"){
		 
		  $("#otherPet").show();
		  
		  
	  }else{
		  
		  $("#otherPet").hide();
		  
	  }
	  
  }
  function showOtherJob(){
	  $("#otherJob").val("");
	  var job = $("#job option:selected").text();
	  
	  if(job=="其他"){
		 
		  $("#otherJob").show();
		  
	  }else{
		 
		  $("#otherJob").hide();
		  
	  }
  }
  
function manageCar(v){
	if(v==0){//有汽车
		$("#automobile_brand").removeAttr("readonly");
	}else if(v==1){//无汽车
		
		$("#automobile_brand").attr("readonly","readonly");
	
	}
}
</script>
<body style="height: 100%">
    <div class="rightcont clear">
        <div class="panel panel-primary">
            <div class="panel-heading">
                基本信息
                <span class="but">
                    <input type="button" id="btnSave" onclick="doMessage()" value="保存"/>
                    <input type="button" onclick="doBack();" value="返回"/>
                    <input type="hidden" id="city_id" />
                </span>
            </div>
            <form id="base_form">
            <div class="panel-body" style="height: 80%;">
                <div id="div_customer" style="float:left;width: 55%;height: 100%">
                    <table id="tiny_village_table" cellpadding="0" cellspacing="0" style="min-width: 100%;margin: 10px; width: auto">
                        <tr>
                            <td width="10%">姓&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;名<span style="color: red">*</span></td>
                            <td width="90%">
                                <input id="id" name="id" type="hidden"/>
                                <input id="employee_no" name="employee_no" type="hidden"/>
                                <input id="create_user_id" name="create_user_id" type="hidden"/>
                                <input id="create_user" name="create_user" type="hidden"/>
                                <input id="name" name="name" type="text" class="form-control" style="width: 40%"/>
                            </td>
                        </tr>
                        <tr>
                            <td>电&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;话<span style="color: red">*</span></td>
                            <td>
                                <input id="mobilephone" name="mobilephone" type="text" class="form-control" onkeyup="this.value=this.value.replace(/\D/g,'')" maxlength="11" style="width: 40%"/>
                            </td>
                        </tr>
                        <tr>
                            <td>年&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;龄</td>
                            <td>
                                <div class="input-group" style="width: 40%">
                                    <input id="age" name="age" type="text" class="form-control" onkeyup="this.value=this.value.replace(/\D/g,'')" maxlength="3"/>
                                    <span class="input-group-addon">岁</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>性&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;别</td>
                            <td>
                                <input  name="sex" type="radio" value="0" checked/>男&nbsp;
                                <input  name="sex" type="radio" value="1"/>女&nbsp;
                            </td>
                        </tr>
                        <tr>
                        	<td>房屋类型</td>
                        	<td>
                        		<input  name="house_type" type="radio" value="1" bidTableFlag="true"  checked/>楼房&nbsp;
		                        <input  name="house_type" type="radio" value="0" bidTableFlag="true" />平房&nbsp;
                        	</td>
                        </tr>
                        <tr>
                            <td>家&nbsp;庭&nbsp;住&nbsp;址</td>
                            <td>
                                <input id="tv_id" name="tv_id" type="hidden" bidTableFlag="true" />
                                <input id="tv_name" name="tv_name" maxlength="40" type="text" class="form-control" bidTableFlag="true" list="tv_name-search" style="display: inherit;width: 20%"/>&nbsp;&nbsp;<span id="span_tv">小区</span>
                                <datalist id="tv_name-search">
<!--                                     <option value="1"> -->
<!--                                     <option value="2"> -->
                                </datalist>
                                <input id="building_id" name="building_id" bidTableFlag="true" type="hidden" />
                                <input id="building_name" maxlength="10" name="building_name" type="text"  list="building_name-search" class="form-control" bidTableFlag="true" style="display: inherit;width: 10%"/>&nbsp;&nbsp;<span id="building_span">号楼</span>
                                <datalist id="building_name-search">
                                </datalist>
                                <input id="house_id" name="house_id" type="hidden" bidTableFlag="true" />
                                <input id="unit_no" name="unit_no" maxlength="10" type="text"  list="unit_no-search" class="form-control building" bidTableFlag="true" style="display: inherit;width: 10%"/>&nbsp;&nbsp;<span id="unit_span">单元</span>
                                <datalist id="unit_no-search">
                                </datalist>
                                <input id="house_no" name="house_no" type="text"  list="house_no-search"  bidTableFlag="true" class="form-control building" style="display: inherit;width: 10%"/>&nbsp;&nbsp;<span id="house_span">房间号</span>
                                <datalist id="house_no-search">
                                </datalist>
                            </td>
                        </tr>
                        <tr>
                            <td>民&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;族</td>
                            <td>
                                <!-- <div class="input-group" style="width: 40%">
                                    <input id="nationality" name="nationality" type="text" class="form-control"/>
                                    <span class="input-group-addon">族</span>
                                </div> -->
                                 <select id="nationality" name="nationality" type="text" class="form-control" style="width: 40%">
                               
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>住&nbsp;房&nbsp;性&nbsp;质</td>
                            <td>
                                <input  name="house_property" type="radio"  value="1" checked/>自有&nbsp;
                                <input  name="house_property" type="radio" value="2"/>租住&nbsp;
                            </td>
                        </tr>
                        <tr>
                            <td>职&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;业</td>
                            <td>
                            <!-- <input id="job" name="job" type="text" class="form-control" style="width: 40%"/> -->
                                <select id="job" name="job" type="text" class="form-control" style="width: 40%" onchange="showOtherJob()">
                               
                                </select>
                                <input type="text"  id="otherJob" style="display:none;width:40%"   class="form-control"/>
                            </td>
                        </tr>
                        <tr>
                            <td>收&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;入</td>
                            <td>
                                <select id="income" name="income" class="form-control"  style="width: 40%">
                                    <option value="">请选择</option>
                                    <option value="0-6000">0-6000</option>
                                    <option value="6001-10000">6001-10000</option>
                                    <option value="10001-15000">10001-15000</option>
                                    <option value="15001-20000">15001-20000</option>
                                    <option value="20000以上">20000以上</option>
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>加&nbsp;班&nbsp;频&nbsp;率</td>
                            <td>
                                <select id="work_overtime" name="work_overtime" type="text" class="form-control" style="width: 40%">
                               
                                </select>
                            </td>
                        </tr>
                        <tr>
                            <td>其&nbsp;他&nbsp;信&nbsp;息</td>
                            <td>
                                <input name="other" id="other" type="text" class="form-control" style="width: 40%" />
                            </td>
                        </tr>
                        <tr>
                            <td>家庭人口数</td>
                            <td>
                                <div class="input-group" style="width: 40%">
                                    <input id="family_num" name="family_num" onkeyup="this.value=this.value.replace(/\D/g,'')" type="text" class="form-control" />
                                    <span class="input-group-addon">人</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>学龄前人数</td>
                            <td>
                                <div class="input-group" style="width: 40%">
                                    <input id="preschool_num" name="preschool_num" type="text" onkeyup="this.value=this.value.replace(/\D/g,'')" class="form-control" />
                                    <span class="input-group-addon">人</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>未成年人数</td>
                            <td>
                                <div class="input-group" style="width: 40%">
                                    <input id="minor_num" name="minor_num" type="text" onkeyup="this.value=this.value.replace(/\D/g,'')" class="form-control" />
                                    <span class="input-group-addon">人</span>
                                </div>
                            </td>
                        </tr>
                        <tr>
                            <td>宠&nbsp;物&nbsp;种&nbsp;类</td>
                            <td>
<!--                                 <input id="pet_type" name="pet_type" type="text" class="form-control"  style="width: 40%" />
 -->                           
 							 	<select id="pet_type" name="pet_type" type="text" class="form-control" style="width: 40%" onchange="showOtherPet()">
                               
                                </select>
                                <input type="text"  id="otherPet" style="display:none;width:40%"   class="form-control"/>
 							 </td>
                        </tr>
                    </table>
                </div>
                <div style="float:right;width: 44%;">
                    <div>
                        <div style="text-align: center">
                        	<span >照片 &nbsp;&nbsp;</span>
                            <img  src="" id="cus_pic" style="border-radius:50%;border: 1px;width: 128px;height: 128px" />
                        </div>
                        <div style="text-align: center">
                            <input type="hidden" id="customer_pic" name="customer_pic"/>
                            <input type="file" id="uploader_pic" name="uploader_pic"   style="display: none"/>
                            &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;
                            <span onclick="$('#uploader_pic').click();" style="color:blue;cursor:pointer">更换图片</span>
                        </div>
                    </div>
                   
                    
                    <div class="panel panel-default" style="margin: 10px 10% 10px 8%">
                        <div class="panel-heading">
                            房屋信息
                        </div>
                        <div class="panel-body">
                            <table cellpadding="0" cellspacing="0" style="min-width: 100%;margin: 10px; width: auto">
                                <tr>
                                    <td width="30%">
                                        面&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;积
                                        <input id="house_style_id" name="house_style_id" type="hidden" bidTableFlag="true" />
                                    </td>
                                    <td width="70%">
                                        <div class="input-group" style="width: 90%">
                                            <input id="house_area" name="house_area" type="text" class="form-control" onkeyup="this.value=this.value.replace(/[^\d|^\.]/g,'')" maxlength="6" bidTableFlag="true" />
                                            <span class="input-group-addon">㎡</span>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                    <td>户&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;型</td>
                                    <td>
                                        <input id="house_style" name="house_style" type="text" class="form-control" bidTableFlag="true" style="width: 90%"/>
                                    </td>
                                </tr>
                                <tr>
                                    <td>朝&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;向</td>
                                    <td>
                                        <input id="house_toward" name="house_toward" type="text" class="form-control" style="width: 90%"  bidTableFlag="true"/>
                                    </td>
                                </tr>
                                <tr class="building">
                                    <td>户型图</td>
                                    <td>
                                        <img src="../images/plus.png" style="width: 32px;height: 32px;opacity: 0.3" onclick="showHouse_pic();">
                                        <label id="house_pic" name="house_pic"></label>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    <div class="panel panel-default" style="margin: 10px 10% 10px 8%">
                        <div class="panel-heading">
                            家庭成员
                            <span class="but">
                                <input type="button" value="详情" style="border: 1px black solid" onclick="doShowRelation()"/>
                            </span>
                        </div>
                        <div class="panel-body">
                            <div class="table-responsive">
                                <table id="relationTable" class="table table-striped table-bordered table-hover" style="width: 100%">
                                    <thead>
                                        <tr>
                                            <th width="22%">成员<br/>关系</th>
                                            <th width="22%">成员<br/>名称</th>
                                            <th width="34%">成员<br/>电话</th>
                                            <th width="22%">成员<br/>年龄</th>
                                        </tr>
                                    </thead>
                                    <tbody>

                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
               
            </div>
             <div id="moreInfo_open" style="position:relative;left:50%;bottom:18px;width:30px;height:25px;cursor:pointer;display:inline" onclick="openMoreInfo()">
           		  <img  src="../images/product-fleches.png" alt="展开更多信息" style="width:25px;height:15px;" />
           		  <span style="position:relative;top:18px;right:43px;color:#D5D5D5" >更多信息</span>
           	</div>
            <!-------------------------------------------------------- 更多信息-------------------------------------------------------- -->
            <div id="moreInfo" style="display:none">
            	  <div class="panel-body" style="height: 80%;">
            	  		<div style="height:2px；margin:10px 0px 40px">
		        	        <div style="position:relative;left:5%;top:5px;width:410px;height:0.5px;padding:0px;overflow:hidden;border:1px dashed  #C0C0C0;"></div>
		        	         <span style="position:relative;top:-6px;left:49%;color:#D5D5D5">更多信息</span>
		        	        <div style="position:relative;left:28%;top:-17px;width:410px;height:0.5px;margin:0px auto 40px;padding:0px;overflow:hidden;border:1px dashed  #C0C0C0;"></div>
            	  		</div>
            	  		<input type="hidden" id="customerData_id" />
		                <div  style="float:left;width: 45%;height: 100%">
		                    <table id="tiny_village_table" cellpadding="0" cellspacing="0" border="0" style="min-width: 100%;margin: 10px; width: auto">
		                        <tr>
		                            <td width="10%">国&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;籍</td>
		                            <td width="90%">
		                                <select id="nationality_gj" name="nationality" type="text" class="form-control" style="display:inline;">
                               				<option value="">请选择</option>
                               				<option value="中国">中国</option>
                               				<option value="美国">美国</option>
                               				<option value="英国">英国</option>
                               				<option value="德国">德国</option>
                               				<option value="法国">法国</option>
                               				<option value="日本">日本</option>
                               				<option value="韩国">韩国</option>
                               				<option value="澳大利亚">澳大利亚</option>
                               				<option value="非洲">非洲</option>
                               				<option value="其他国家">其他国家</option>
                                		</select>
		                            </td>
		                            
		                        </tr>
		                        <tr>
		                            <td >籍&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;贯</td>
		                            <td >
		                            	 <select id="native_place_pro" name="native_place_pro" type="text"  class="form-control" onchange="setNativeCity()" style="display:inherit;width: 50%">
                               				<option value="">请选择</option>
                                		 </select>
                                   
                                		 <select id="native_place_city" name="native_place_city" type="text" class="form-control" style="display:inherit;width: 49%">
                               				<option value="">请选择</option>
                                		 </select>
		                            </td>
		                        </tr>
		                        <tr>
		                            <td>户籍所在地&nbsp;</td>
		                            <td>
		                               
		                                    <select id="local_pro" name="local_pro" type="text" class="form-control" style="display:inherit;width: 50%" onchange="setLocalCity()">
                               					<option value="">请选择</option>
                                		 	</select>
                                	
                                		 	<select id="local_city" name="local_city" type="text" class="form-control" style="display:inherit;width: 49%">
                               					<option value="">请选择</option>
                                		 	</select>
		                               
		                            </td>
		                        </tr>
		                        <tr>
		                            <td>婚姻状况</td>
		                            <td>
		                               <select id="marital_status" name="marital_status" type="text" class="form-control" style="display:inherit;">
                               				<option value="">请选择</option>
                               				<option value="已婚">已婚</option>
                               				<option value="未婚">未婚</option>
                               				<option value="离异">离异</option>
                                	   </select>
		                            </td>
		                           
		                        </tr>
		                        <tr>
		                            <td>健康状况</td>
		                            <td>
		                                <select id="health_condition" name="health_condition" type="text" class="form-control" style="display:inherit;">
                               				<option value="">请选择</option>
                               				<option value="健康">健康</option>
                               				<option value="亚健康">亚健康</option>
                               				<option value="慢性病">慢性病</option>
                               				<option value="重病">重病</option>
                               				<option value="残疾">残疾</option>
                               				<option value="其他">其他</option>
                                	   </select>
		                            </td>
		                            
		                        </tr>
		                        <tr>
		                            <td>教育程度</td>
		                            <td>
	                                   <select id="degree_of_education" name="degree_of_education" type="text" class="form-control" style="display:inherit;">
                               				<option value="">请选择</option>
                               				<option value="博士">博士</option>
                               				<option value="硕士">硕士</option>
                               				<option value="本科">本科</option>
                               				<option value="大专">大专</option>
                               				<option value="高中">高中</option>
                               				<option value="初中">初中</option>
                               				<option value="小学">小学</option>
                               				<option value="其他">其他</option>
                               	   		</select>
		                            </td>
		                           
		                        </tr>
		                        <tr>
		                            <td>学校名称</td>
		                            <td>
		                                <input id="school_name" name="school_name" type="text" class="form-control" style="display:inherit;"/>
		                            </td>
		                        </tr>
		                        <tr>
		                   			<td>理财习惯</td>
		                   			<td>
		                   			<select id="money_manage" name="money_manage" type="text" class="form-control" style="display:inherit;">
	                       				<option value="">请选择</option>
	                       				<option value="存款">存款</option>
	                       				<option value="购买基金">购买基金</option>
	                       				<option value="购买股票">购买股票</option>
	                       				<option value="购买黄金">购买黄金</option>
	                       				<option value="购买白银">购买白银</option>
	                       				<option value="购买其他理财产品">购买其他理财产品</option>
	                       				<option value="无理财习惯">无理财习惯</option>
	                       				<option value="其他">其他</option>
                                	</select>
		                   			</td>
		                   		</tr>
		                       
		                   		
		                    </table>
		                </div>
		                <div style="float:right;width: 44%;height: 100%;margin:10px 10px 0px">
		                   	<table  cellpadding="0" cellspacing="0" border="0" style="min-width: 100%;margin: 10px; width: auto">
		                   		 <tr>
		                            <td width="10%">汽车信息</td>
		                            <td width="90%">
		                                <input id="is_car_y" onclick="manageCar(0)" name="is_car" type="radio" value="0" bidTableFlag="true" checked/>有&nbsp;
		                        		<input  id="is_car_n" onclick="manageCar(1)" name="is_car" type="radio" value="1" bidTableFlag="true"  />无&nbsp;
		                            </td>
		                        </tr>
		                   		<tr>
		                   			<td width="10%">汽车品牌</td>
		                   			<td>
		                   				<input  name="automobile_brand" id="automobile_brand" type="text" class="form-control" style="display:inherit;" />
		                   			</td>
		                   		</tr>
		                   		
		                   		<tr>
		                   			<td>性格</td>
		                   			<td>
		                   				<select id="character_data" name="character_data" type="text" class="form-control" style="display:inherit;">
		                       				<option value="">请选择</option>
		                       				<option value="外向开朗">外向开朗</option>
		                       				<option value="热情">热情</option>
		                       				<option value="自信">自信</option>
		                       				<option value="幽默风趣">幽默风趣</option>
		                       				<option value="谨慎">谨慎</option>
		                       				<option value="不善言辞">不善言辞</option>
		                       				<option value="其他">其他</option>
		                                </select>
		                   			</td>
		                   		</tr>
		                   		<tr>
		                   			<td>家庭年收入</td>
		                   			<td>
		                   				<select id="household_income" name="household_income" type="text" class="form-control" style="display:inherit;">
		                       				<option value="">请选择</option>
		                       				<option value="1万以下">1万以下</option>
		                       				<option value="1-5万">1-5万</option>
		                       				<option value="5-10万">5-10万</option>
		                       				<option value="10-20万">10-20万</option>
		                       				<option value="20-30万">20-30万</option>
		                       				<option value="30-50万">30-50万</option>
		                       				<option value="50-100万">50-100万</option>
		                       				<option value="100万+">100万+</option>
		                                </select>
		                   			</td>
		                   		</tr>
		                   		<tr>
		                   			<td>购物渠道习惯&nbsp;</td>
		                   			<td>
		                   				<select id="shopping_channel" name="shopping_channel" type="text" class="form-control" style="display:inherit;">
		                       				<option value="">请选择</option>
		                       				<option value="仅在实体店购物">仅在实体店购物</option>
		                       				<option value="实体店为主">实体店为主</option>
		                       				<option value="网购为主">网购为主</option>
		                       				<option value="两者结合">两者结合</option>
		                                </select>
		                   			</td>
		                   		</tr>
		                   		<tr>
		                   			<td>兴趣爱好1</td>
		                   			<td>
		                   				<input  name="hobby_one" id="hobby_one" type="text" class="form-control" style="display:inherit;"/>
		                   			</td>
		                   		</tr>
		                   		<tr>
		                   			<td>兴趣爱好2</td>
		                   			<td>
		                   				<input  name="hobby_two" id="hobby_two" type="text" class="form-control" style="display:inherit;"/>
		                   			</td>
		                   		</tr>
		                   		<tr>
		                   			<td>兴趣爱好3</td>
		                   			<td>
		                   				<input  name="hobby_three" id="hobby_three" type="text" class="form-control" style="display:inherit;"/>
		                   			</td>
		                   		</tr>
		                   		</table>
		                </div> 
           		  		<img id="moreInfo_close" src="../images/product-fleches_1.png" alt="收起更多信息" style="position:relative;right:-44px;top:405px;width:25px;height:15px;cursor:pointer" onclick="closeMoreInfo()"/>
            	</div>
            </div>
			</form>
            <div id="family_div" style="display: none;">
                <div id="div_btn" style="float: left;width: 30%;margin-top: 7%;margin-right: 2%;" onclick="addFamily()">
                    <div class="increase">
                        <div class="inc1"></div>
                        <div class="inc2"></div>
                    </div>
                </div>
            </div>
             <div id="new_address_div" style="display:none;height:360px">
                <div>
                   	<table cellpadding="0" cellspacing="0" id="new_address" style="min-width: 100%;width: auto;">
                   		<tr><td width="8px">街道<span style="color:red">*</span></td>
                   			<td>
	                   			<input type="text" name="town_name" id="town_name" list="town_name-search" bidTableFlag="true" class="form-control"  style= "width:100%"/>
	                   			<input type="hidden" class="form-control"   name="town_id" id="town_id"/>
                   				<datalist id="town_name-search">
		                        </datalist>
                   			</td>
                   		</tr> 
                   		<tr><td width="8px">社区<span style="color:red">*</span></td>
	                   		<td>
	                   			<input type="hidden" name="village_id" id="village_id"/>
	                   			<input type="text" class="form-control" list="village_name-search" bidTableFlag="true"  name="village_name" id="village_name" style= "width:100%"> 
		                   		<datalist id="village_name-search">
		                        </datalist>
	                   		</td>
	                   	</tr>
                   		<tr><td width="8px" ><span id="new_tinvillage_name">小区</span><span style="color:red">*</span></td><td><input type="text" maxlength="40" class="form-control" name="tin_village" id="tin_village" style= "width:100%"></td></tr>
                   		<tr><td width="8px">小区地址&nbsp;</td><td><input type="text" class="form-control" name="tin_village_address" maxlength="50" id="tin_village_address" style= "width:100%"></td></tr>
                   		<tr id="building_tr"><td  width="8px">楼号<span style="color:red">*</span></td><td><input type="text" class="form-control"  maxlength="10" name="building" id="new_building" style= "width:100%"></td></tr>
                   		<tr id="unit_tr"><td width="8px">单元<span style="color:red">*</span></td><td><input type="text" class="form-control"  maxlength="10" name="unit_no" id ="new_unit_no" style= "width:100%"></td></tr>
                   		<tr ><td  width="8px"><span id="new_house_name">房间号</span><span style="color:red">*</span></td><td><input type="text" class="form-control" maxlength="10" name="house_no" id="new_house_no" style= "width:100%"></td></tr>
                   	 </table>
                  </div>	
            </div>
         
           <!--  <div id="relation_div">
                <form id="pmsForm" name="pmsForm" class="pmsForm" validate="true" clientvalidate="true" displaynumber="7">
                    <div id="div_relation_btn" style="float: left;width: 30%;margin-top: 7%;margin-right: 2%;" onclick="addRelation()">
                        <div class="increase">
                            <div class="inc1"></div>
                            <div class="inc2"></div>
                        </div>
                    </div>
                </form>
            </div> -->

        </div>
    </div>
    
<script type="text/javascript">

    var lst_select_tiny = null;
    var lst_building = null;
    var map_house = null;
    var lst_house = null;
    var lst_select_village=null;
    
    $('#tv_name').keyup(function(event){
    	 var str_name = $(this).val();
   	     var reg = /^\s+|\s+$/g;
         str_name = str_name.replace(reg,'');
    	
         $('#building_name-search').children().remove();
         $('#building_name').val("");
        
         $('#unit_no-search').children().remove();
         $('#unit_no').val("");
        
         $('#house_no-search').children().remove();
         $('#house_no').val("");
		 var city_id = $("#city_id").val();
		 if(city_id==""){
			city_id = null;
		 }
		
        str_name = $(this).val();
        if(!(event.keyCode >= 37 && event.keyCode <= 40) && event.keyCode != 13){
        	$("#tv_id").val("");
            $('#tv_name-search').children().remove();
            if(str_name == null || str_name == "" || str_name.indexOf('\'') > -1){
                return;
            }
            doManager('TinyVillageManager','getTinyVillageByNameAndCity',[str_name,$('input[name="house_type"]:checked').val(),city_id],function(data){
                if(data.result){
                    lst_select_tiny = JSON.parse(data.data);
                    $(lst_select_tiny).each(function(index,element){
                        $('#tv_name-search').append('<option value="'+element.name+'">');
                    });
                }else{
                    $$.showMessage("提示",data.message);
                }
            });
        }
    });

     $('#tv_name').change(function(){
    	 $('#building_name-search').children().remove();
         $('#building_name').val("");
        
         $('#unit_no-search').children().remove();
         $('#unit_no').val("");
        
         $('#house_no-search').children().remove();
         $('#house_no').val("");
         $(lst_select_tiny).each(function(index,element){
            if(element.name == $('#tv_name').val()){
                $('#tv_id').val(element.id);
                var house_type=$('input[name="house_type"]:checked').val();
                if(house_type=="1"){
                	building_option();
                }else{
                	house_option_pingfang();
                }
                
            }
         });
    }); 
    
 

    
    $('#village_name').keyup(function(event){

        var str_name = $(this).val();
   	    var reg = /^\s+|\s+$/g;
        str_name = str_name.replace(reg,'');
        if(!(event.keyCode >= 37 && event.keyCode <= 40) && event.keyCode != 13){
        	$('#village_id').val("");
            $('#village_name-search').children().remove();
            if(str_name == null || str_name == "" || str_name.indexOf('\'') > -1){
                return;
            }
            var townId = $('#town_id').val();
            if(townId==null||townId==""){
            	return;
            }
            doManager('VillageManager','searchVillageByTownAndName',[townId,str_name],function(data){
                if(data.result){
                	lst_select_village = JSON.parse(data.data);
                    $(lst_select_village).each(function(index,element){
                        $('#village_name-search').append('<option value="'+element.name+'">');
                    });
                }else{
                    $$.showMessage("提示",data.message);
                }
            });
        }
    });
    
    
    $('#village_name').change(function(){
    	
        $(lst_select_village).each(function(index,element){
            if(element.name == $('#village_name').val()){
                $('#village_id').val(element.id);
            }
        });
    });
    
    //街道
    $('#town_name').keyup(function(event){
		var city_id =  $("#city_id").val();
		if(city_id==""){
			city_id=null;
		}
		var str_name = $(this).val();
   	    var reg = /^\s+|\s+$/g;
        str_name = str_name.replace(reg,'');
        if(!(event.keyCode >= 37 && event.keyCode <= 40) && event.keyCode != 13){
        	$("#town_id").val("");
            $('#town_name-search').children().remove();
            if(str_name == null || str_name == "" || str_name.indexOf('\'') > -1){
                return;
            }
            doManager('TownManager','selectAllTownByName',[str_name,city_id],function(data){
                if(data.result){
                	lst_select_village = JSON.parse(data.data);
                    $(lst_select_village).each(function(index,element){
                        $('#town_name-search').append('<option value="'+element.name+'">');
                    });
                }else{
                    $$.showMessage("提示",data.message);
                }
            });
        }
    });
    
    
    $('#town_name').change(function(){
    	
        $(lst_select_village).each(function(index,element){
            if(element.name == $('#town_name').val()){
                $('#town_id').val(element.id);
            }
        });
    });
    
    function building_option(){
    	layer.msg("'楼号' 加载中", {
    		  icon: 16
    		  ,shade: 0.01,
    		  time:100000
    		}); 
       
       
        var tv_id = $('#tv_id').val();
        if(tv_id == '' || tv_id == null){
        	layer.closeAll();
            return;
        }
        doManager('BuildingManager','getBuildingListByTinyVillageId',tv_id,function(data){
            if(data.result){
            	
                lst_building = JSON.parse(data.data);
                $(lst_building).each(function(index,element){
                    $('#building_name-search').append('<option data="'+element.id+'" value="'+element.name+'">');
                });
                layer.closeAll();
            }else{
                $$.showMessage("提示",data.message);
            }
        });
    }

    $('#building_name').change(function(){
    	$('#unit_no-search').children().remove();
        $('#unit_no').val("");
       
        $('#house_no-search').children().remove();
        $('#house_no').val("");
        building_value();
    });
    
    $('#building_name').keyup(function(event){
    	$('#building_name-search').children().remove();
    	$('#building_id').val("");
    	lst_building = null;
    	lst_unit=null;
    	lst_house=null;
    	map_house=null;
        building_option();
        building_value();
    })
    function building_value(){
        $(lst_building).each(function(index,element){
            if(element.name == $('#building_name').val()){
            	
                $('#building_id').val(element.id);
                unit_option();
            }
        });
    }

    $('#unit_no').change(function(){
        house_option();
    });
    $('#unit_no').keyup(function(event){
        house_option();
        $('#house_id').val("");
    });
    function unit_option(){
    	layer.msg("'单元' 加载中", {
    		  icon: 16
    		  ,shade: 0.01,
    		  time:100000
    		});
    	
        $('#unit_no-search').children().remove();
        $('#unit_no').val("");
        var b_id = $('#building_id').val();
        if(b_id == '' || b_id == null){
        	layer.closeAll();
            return;
        }
        doManager('HouseManager','getHouseListByBuildingId',b_id,function(data){
            if(data.result){
            	
                var map_house_unit = JSON.parse(data.data);
                var lst_unit = map_house_unit['unit'];
                map_house = map_house_unit['house'];
                $(lst_unit).each(function(index,element){
                    $('#unit_no-search').append('<option value="'+element+'">');
                });
               layer.closeAll();
            }else{
                $$.showMessage("提示",data.message);
            }
        });
    }
	//平房的门牌号
    function house_option_pingfang(){
    	layer.msg("'门牌号' 加载中", {
  		  icon: 16
  		  ,shade: 0.01,
  		  time:100000
  		});
    	var tv_id = $('#tv_id').val();
        if(tv_id == '' || tv_id == null){
        	layer.closeAll();
            return;
        }
    	  doManager('HouseManager','getHouseOfTinyVillage',tv_id,function(data){
              if(data.result){
              	
                  var houseData = JSON.parse(data.data);
                  var hlist = houseData.houselist;
                 
                  $(hlist).each(function(index,element){
                      $('#house_no-search').append('<option value="'+element.house_no+'">');
                  });
                 layer.closeAll();
              }else{
                  $$.showMessage("提示",data.message);
              }
          });
    }
    //楼房的门牌号
    function house_option(){
    	
    	/* layer.msg("'房间号' 加载中", {
  		  icon: 16
  		  ,shade: 0.01,
  		  time:100000
  		});  */
        $('#house_no-search').children().remove();
        $('#house_no').val("");
        var unit_no = $('#unit_no').val();
      
        if(unit_no == '' || unit_no == null){
            return;
        }
        
        if(map_house == null || typeof(map_house) == 'undefined'){
            return;
        }
        
        lst_house = map_house[unit_no];
       
        $(lst_house).each(function(index,element){
            $('#house_no-search').append('<option value="'+element.building_house_no+'">');
        });
        
        //layer.closeAll();
    }

    $('#house_no').change(function(){
        house_value();
    });
    $('#house_no').keyup(function(event){
       
        $('#house_id').val("");
    });
    function house_value(){
    	var house_type = $('input[name="house_type"]:checked').val();
    	if(house_type==0){//平房
    		$(lst_house).each(function(index,element){
                if(element.house_no == $('#house_no').val()){
                    $('#house_id').val(element.id);
                    doManager('HouseStyleManager','getHouseStyleByHouseId',[element.id],function(data){
                        if(data.result == true){
                            var house_style = JSON.parse(data.data);
                            if(house_style == null){
                                return;
                            }
                            $('#house_style').val(house_style.house_style);
                            $('#house_toward').val(house_style.house_toward);
                            $('#house_area').val(house_style.house_area);
                            $('#house_pic').val(house_style.house_pic);
                            $('#house_style_id').val(house_style.id);
                        }
                    });
                }
            });
    	}else if(house_type==1){//楼房
    		$(lst_house).each(function(index,element){
                if(element.building_house_no == $('#house_no').val()){
                    $('#house_id').val(element.id);
                    doManager('HouseStyleManager','getHouseStyleByHouseId',[element.id],function(data){
                        if(data.result == true){
                            var house_style = JSON.parse(data.data);
                            if(house_style == null){
                                return;
                            }
                            $('#house_style').val(house_style.house_style);
                            $('#house_toward').val(house_style.house_toward);
                            $('#house_area').val(house_style.house_area);
                            $('#house_pic').val(house_style.house_pic);
                            $('#house_style_id').val(house_style.id);
                        }
                    });
                }
            });
    	}

    }

    $('#name').blur(function(){
        findCustomer();
    });
    $('#mobilephone').blur(function(){
        findCustomer();
    });

    function findCustomer() {
        var customer_parameter = {
            name: $('#name').val(),
            mobilephone: $('#mobilephone').val()
        }
        if(customer_parameter.name != null && customer_parameter.name != '' &&
                customer_parameter.mobilephone != null && customer_parameter.mobilephone != '') {
            doManager('CustomerManager', 'findCustomerInfo', customer_parameter, function(data) {
                if(data.result) {
                    var customer = JSON.parse(data.data);
                    if(customer != null) {
                        viewValue(customer);
                    }
                }
            });
        }

    }
</script>
</body>
</html>